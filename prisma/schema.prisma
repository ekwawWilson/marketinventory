// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =====================
// ENUMS
// =====================

enum Role {
  OWNER
  STORE_MANAGER
  CASHIER
  INVENTORY_MANAGER
  ACCOUNTANT
  STAFF
}

enum TenantStatus {
  TRIAL
  ACTIVE
  SUSPENDED
}

enum PaymentType {
  CASH
  CREDIT
}

enum PaymentMethod {
  CASH
  MOMO
  BANK
}

enum StockAdjustmentType {
  INCREASE
  DECREASE
}

enum ReturnType {
  CASH
  CREDIT
  EXCHANGE
}

// =====================
// CORE MULTI-TENANT
// =====================

model Tenant {
  id                           String   @id @default(uuid())
  name                         String
  phone                        String?
  status                       TenantStatus @default(TRIAL)
  users                        User[]
  branches                     Branch[]
  createdAt                    DateTime @default(now())

  // Receipt Settings
  showManufacturerOnReceipt    Boolean  @default(true)
  receiptPrinterWidth          String   @default("80mm")  // "58mm" or "80mm"

  // Unit System
  // When enabled, items have a unit name (e.g. "carton") and piecesPerUnit (e.g. 12).
  // Stock is tracked in the base unit (cartons). Quantities can be fractional (1.5 cartons).
  useUnitSystem                Boolean  @default(false)

  // Pricing Tiers — when enabled, items carry extra price tiers selectable at sale time
  enableRetailPrice            Boolean  @default(false)
  enableWholesalePrice         Boolean  @default(false)
  enablePromoPrice             Boolean  @default(false)

  // Discounts — when enabled, cashier can apply a discount (% or fixed amount) per sale
  enableDiscounts              Boolean  @default(false)

  // SMS Notifications — Hubtel Ghana SMS Gateway
  enableSmsNotifications       Boolean  @default(false)
  hubtelClientId               String?
  hubtelClientSecret           String?
  hubtelSenderId               String?  // e.g. "PETROS" (max 11 chars, no spaces)

  // Feature Flags — enable/disable optional modules from Settings
  enablePosTerminal            Boolean  @default(false)
  enableQuotations             Boolean  @default(false)
  enablePurchaseOrders         Boolean  @default(false)
  enableExpiryTracking         Boolean  @default(false)
  enableBranches               Boolean  @default(false)
  enableCreditSales            Boolean  @default(false)
  enableExpenses               Boolean  @default(false)
  enableTill                   Boolean  @default(false)
}

// =====================
// USERS & AUTH
// =====================

model User {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  email     String   @unique
  password  String
  role      Role
  branchId  String?  // optional: assign user to a specific branch
  branch    Branch?  @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
}

// =====================
// BRANCHES
// =====================

model Branch {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  address   String?
  phone     String?
  isDefault Boolean  @default(false)  // one branch per tenant is the "main" branch
  createdAt DateTime @default(now())

  users     User[]
}

// =====================
// MANUFACTURERS
// =====================

model Manufacturer {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  items     Item[]
  createdAt DateTime @default(now())
}

// =====================
// ITEMS & INVENTORY
// =====================

model Item {
  id              String @id @default(uuid())
  tenantId        String
  branchId        String?  // optional: null = shared across all branches
  manufacturerId  String
  manufacturer    Manufacturer @relation(fields: [manufacturerId], references: [id])
  name            String
  quantity        Float    @default(0)   // Float supports fractional units (e.g. 1.5 cartons)
  costPrice       Float
  sellingPrice    Float
  retailPrice     Float?   // optional retail price tier
  wholesalePrice  Float?   // optional wholesale price tier
  promoPrice      Float?   // optional promotional price tier
  barcode         String?                    // optional barcode / SKU for POS scanning
  expiryDate      DateTime?                  // optional expiry date tracking
  createdAt       DateTime @default(now())

  // Unit System fields (only meaningful when tenant.useUnitSystem = true)
  unitName        String?  @default("unit")   // e.g. "carton", "bag", "box"
  piecesPerUnit   Int?     @default(1)         // e.g. 12 pieces per carton

  saleItems      SaleItem[]
  purchaseItems  PurchaseItem[]
}


// =====================
// CUSTOMERS (DEBTORS)
// =====================

model Customer {
  id        String @id @default(uuid())
  tenantId  String
  name      String
  phone     String?
  balance   Float @default(0)
  sales     Sale[]
}

// =====================
// SUPPLIERS (CREDITORS)
// =====================

model Supplier {
  id        String @id @default(uuid())
  tenantId  String
  name      String
  phone     String?
  balance   Float @default(0)
  purchases Purchase[]
}

// =====================
// SALES
// =====================

model Sale {
  id            String         @id @default(uuid())
  tenantId      String
  branchId      String?        // optional: which branch this sale was made at
  customerId    String?
  customer      Customer?      @relation(fields: [customerId], references: [id])
  totalAmount   Float
  paidAmount    Float
  paymentType   PaymentType    // CASH = fully paid, CREDIT = balance owed
  paymentMethod PaymentMethod  @default(CASH) // how money was received: CASH, MOMO, BANK
  createdAt     DateTime       @default(now())
  items         SaleItem[]
}

model SaleItem {
  id             String @id @default(uuid())
  saleId        String
  sale          Sale   @relation(fields: [saleId], references: [id])
  itemId        String
  item          Item   @relation(fields: [itemId], references: [id])
  quantity      Float   // Float supports fractional units
  price         Float
  discountAmount Float  @default(0)  // per-line discount in currency
}



// =====================
// PURCHASES
// =====================
model Purchase {
  id          String @id @default(uuid())
  tenantId    String
  branchId    String?  // optional: which branch received this purchase
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  totalAmount Float
  paidAmount  Float
  paymentType PaymentType
  createdAt   DateTime @default(now())
  items       PurchaseItem[] // relation
}

model PurchaseItem {
  id          String @id @default(uuid())
  purchaseId  String
  purchase    Purchase @relation(fields: [purchaseId], references: [id])
  itemId      String
  item        Item     @relation(fields: [itemId], references: [id])
  quantity    Float    // Float supports fractional units
  costPrice   Float
}

// =====================
// PAYMENTS
// =====================

model CustomerPayment {
  id         String @id @default(uuid())
  tenantId   String
  customerId String
  amount     Float
  method     PaymentMethod
  createdAt  DateTime @default(now())
}

model SupplierPayment {
  id         String @id @default(uuid())
  tenantId   String
  supplierId String
  amount     Float
  method     PaymentMethod
  createdAt  DateTime @default(now())
}

// =====================
// RETURNS
// =====================

model CustomerReturn {
  id        String @id @default(uuid())
  tenantId  String
  saleId    String
  itemId    String
  quantity  Float
  type      ReturnType
  amount    Float
  createdAt DateTime @default(now())
}

model SupplierReturn {
  id        String @id @default(uuid())
  tenantId  String
  purchaseId String
  itemId    String
  quantity  Float
  type      ReturnType
  amount    Float
  createdAt DateTime @default(now())
}

// =====================
// STOCK ADJUSTMENTS
// =====================

model StockAdjustment {
  id        String @id @default(uuid())
  tenantId  String
  branchId  String?  // optional: which branch made this adjustment
  itemId    String
  type      StockAdjustmentType
  quantity  Float
  reason    String
  createdAt DateTime @default(now())
}

// =====================
// EXPENSES
// =====================

enum ExpenseCategory {
  RENT
  SALARIES
  UTILITIES
  TRANSPORT
  MARKETING
  MAINTENANCE
  OTHER
}

model Expense {
  id          String          @id @default(uuid())
  tenantId    String
  branchId    String?  // optional: which branch incurred this expense
  amount      Float
  category    ExpenseCategory
  description String
  paidBy      String?
  createdAt   DateTime        @default(now())
}

// =====================
// TILL / CASH REGISTER
// =====================

enum ShiftStatus {
  OPEN
  CLOSED
}

model CashRegister {
  id              String      @id @default(uuid())
  tenantId        String
  branchId        String?  // optional: which branch this till belongs to
  userId          String
  status          ShiftStatus @default(OPEN)
  openingFloat    Float                         // cash in till at shift start
  closingCount    Float?                        // cash counted at shift close
  expectedCash    Float?                        // calculated: float + cash sales + payments
  variance        Float?                        // closingCount - expectedCash
  note            String?
  openedAt        DateTime    @default(now())
  closedAt        DateTime?
}

// =====================
// QUOTATIONS
// =====================

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model Quotation {
  id          String          @id @default(uuid())
  tenantId    String
  customerId  String?
  status      QuotationStatus @default(DRAFT)
  totalAmount Float
  note        String?
  validUntil  DateTime?
  createdAt   DateTime        @default(now())
  items       QuotationItem[]
}

model QuotationItem {
  id           String    @id @default(uuid())
  quotationId  String
  quotation    Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  itemId       String
  itemName     String    // snapshot of name at time of quote
  quantity     Float
  price        Float
}

// =====================
// PURCHASE ORDERS
// =====================

enum PurchaseOrderStatus {
  DRAFT
  SENT
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  tenantId    String
  supplierId  String?
  status      PurchaseOrderStatus @default(DRAFT)
  totalAmount Float
  note        String?
  expectedAt  DateTime?
  createdAt   DateTime            @default(now())
  items       PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  itemId          String
  itemName        String        // snapshot of name at time of order
  quantity        Float
  costPrice       Float
}

// =====================
// AUDIT LOGS
// =====================

model AuditLog {
  id        String @id @default(uuid())
  tenantId  String
  userId    String
  action    String
  entity    String
  createdAt DateTime @default(now())
}
